services:
  # --- INFRASTRUCTURE ---
  - type: redis
    name: redis-cache
    plan: free
    ipAllowList: [] 

  - type: web
    name: kafka
    plan: starter
    runtime: docker
    dockerContext: .
    dockerfilePath: ./kafka.Dockerfile  # Fixed key name
    envVars:
      - key: KAFKA_ADVERTISED_LISTENERS
        value: PLAINTEXT://kafka:9093
      - key: KAFKA_ZOOKEEPER_CONNECT
        value: zookeeper:2181

  - type: web
    name: zookeeper
    plan: starter
    runtime: docker
    dockerContext: .
    dockerfilePath: ./zookeeper.Dockerfile # Fixed key name

  # --- PRODUCT SERVICES ---
  - type: web
    name: car-insurance-service
    runtime: docker
    dockerContext: ./car-insurance-service
    dockerfilePath: ./car-insurance-service/Dockerfile
    envVars:
      - key: DB_HOST
        fromDatabase:
          name: product-db-car
          property: host
      - key: KAFKA_BROKER
        value: kafka:9093

  - type: web
    name: health-insurance-service
    runtime: docker
    dockerContext: ./health-insurance-service
    dockerfilePath: ./health-insurance-service/Dockerfile
    envVars:
      - key: DB_HOST
        fromDatabase:
          name: product-db-health
          property: host

  - type: web
    name: house-insurance-service
    runtime: docker
    dockerContext: ./house-insurance-service
    dockerfilePath: ./house-insurance-service/Dockerfile
    envVars:
      - key: DB_HOST
        fromDatabase:
          name: product-db-house
          property: host

  - type: web
    name: banking-service
    runtime: docker
    dockerContext: ./banking-service
    dockerfilePath: ./banking-service/Dockerfile
    envVars:
      - key: DB_HOST
        fromDatabase:
          name: product-db-banking
          property: host

  # --- CORE SERVICE ---
  - type: web
    name: core-service
    runtime: docker
    dockerContext: ./core-service
    dockerfilePath: ./core-service/Dockerfile
    plan: starter
    envVars:
      - key: CAR_INSURANCE_SERVICE_URL
        value: http://car-insurance-service:8000
      - key: HEALTH_INSURANCE_SERVICE_URL
        value: http://health-insurance-service:8000
      - key: HOUSE_INSURANCE_SERVICE_URL
        value: http://house-insurance-service:8000
      - key: BANKING_SERVICE_URL
        value: http://banking-service:8000
      - key: REDIS_HOST
        fromService:
          type: redis
          name: redis-cache
          property: host
      - key: DB_HOST
        fromDatabase:
          name: core-db
          property: host

# --- DATABASES ---
databases:
  - name: product-db-car
    plan: free
  - name: product-db-health
    plan: free
  - name: product-db-house
    plan: free
  - name: product-db-banking
    plan: free
  - name: core-db
    plan: free